# erlang编码规范参考

## 基本原则

* 统一风格
* 简明准确
* 安全可靠
* 无潜规则
* 高内聚低耦合
* 避免重复
* 易于维护
* 节约成本
* 便于扩展

## 方法
* 自顶而下, 先把握全局, 最后做细节
* 分而治之, 大问题拆成小问题, 小问题拆成更小的问题
* 先写正确了, 再去考虑速度
* 检查外部输入, 不要相信前端, 不要相信任何外来数据
* 对于无法保证正确性的运算, 保证其不会对产品造成破坏

## 消息
* 用专用的接口函数封装消息通信, 用erlang:send不用"!"
* 消息要打标签(tag)
* 消息结构扁平化, 尺寸尽可能小
* 大量广播的消息要先打包为binary
* 注意timeout不代表对方没有收到或没有处理消息

## 数据库和ETS
* 不持久化协议`p_xxx`结构
* 避免持久化配置内容
* 表字段是字符串时避免用list, 建议转为binary
* 数据扁平化

## 通信协议
* 专项专用, 不要做大而全协议
* 不发可配置信息
* 不发多余信息, 比如不可见的场景元素
* 按需推送
* 大列表分页

## 进程
* 一个进程一个职责, 不要让一个进程处理多种不同事务
* 尽量使用OTP
* 打开`trap_exit`, 除非进程是无状态的(eg.临时进程)
* 正确命名
* 避免形成单点, 该用池的时候要用池
* 避免直接spawn工作进程, 无线增加的工作进程会造成系统性能下降, 用进程池和任务队列
* 谨慎使用call
	* 禁止call role进程
	* 同类进程间禁止随意互相call, 容易出现死锁
	* 单体服务进程: 禁止call别的进程, 避免单点堵消息
	* worker进程: 不禁止call, 具体情况具体分析

## 安全
* 先检查后操作
* 先扣再加, 避免被刷
* 单点写入, 禁止多处操作同一个数据对象(注意数据对象=/=表)
* 注意避免脏数据问题, 例如
	* ProcA 读 D
	* ProcA 发送修改后的数据 D' 给ProcD
	* ProcD 写 D' (可能造成丢失更新)

## 提高性能
* 先跑通再优化性能
* 压缩高频率消息
* bit化数据, 提高位利用率
* 字符串ID化
* 循环合并
* 选择性丢弃消息

## 模块
* 一个模块处理一类问题
* 禁止import
* 尽可能少export, 谨慎使用export_all
* 归类export出来的函数
	* 供其他模块使用的界面
	* 供程序员使用的界面
	* 内部使用(比如用于apply)
* 减少对其他模块的调用
* 避免环形调用, 避免: ModA -> ModB -> ModC -> ModA
* 函数按相关性组织, 相关的放在一起
* 不要泄露私有数据结构
* 把常用的函数按其类型组织在一起, 形成库模块, 库模块不能杂乱无章
* 尽可能使模块中函数运行在同一个进程中

## 头文件
* 用`ifndef`避免重复包含
* 不要把所有东西塞到一个hrl里, 按不同的使用需要选择放到哪里

## 函数
* 不超过50行
* 缩进不要超过3级, 把深缩进分割为小函数
* 供外部使用的函数返回值打标签(tag)
* 压缩传递的参数, 个数少一点, 尺寸小一点, 只传函数需要的东西
* 在变量被赋值的地方使用, 避免一路传递而不使用
* 不要假设调用者会如何使用返回值, 返回结果而不要帮外部处理结果
* 分离"单纯运算代码"与"含副作用的代码"

## 匿名函数和动态调用
* 避免使用匿名函数, 不要持久化匿名函数, 要理解匿名函数的潜在问题
* 尽量少用MFA动态调用(apply)

## 表达式
* 用函数替换`case`
* 不做多余的通配处理, 比如`_Other`
* 非热点代码要用高可读性的写法
* 用强匹配替换`is_record`

## 常量
* 字符串用binary, 日志输出除外
* 禁止魔法数字, 用atom或者宏代替

## 命名
* 基本原则
	* 简明无歧义
	* 统一, 一旦确定就坚持使用, 不要多词同义甚至一词多义
	* 使用英语单词或其缩写, 不用拼音, 更不要用拼音缩写
	* 缩写词全大写, 除非在atom中
	* 不超过5个单词
* atom: 全小写, "\_"分割, 例: `role_id`
* 变量名
	* 单词首字母大写, 不使用"\_", 例: `RoleId`
	* 布尔值的, 用`IsXxx`
* 宏: 全大写, "\_"分割, 例: `?ROLE_ID`
* 协议(atom)
	* `xxxxx_c2s`/`xxxxx_s2c`
	* `p_xxxxx`
* 函数名(atom)
	* 要能表达函数功能
		* 例: `check_xxx`, `do_xxx`, `calc_xxx`, `send_xxx`
	* 要暗示返回的值
		* 返回布尔值的, 用`is_xxx`
* 功能模块：以功能名划分文件夹
	* 协议处理模块: `mod_<name>`
	* 功能主流程模块: `<name>`
	* 功能公共接口模块: `<name>_util`
	* gen_server模块: `<name>_server`
	* sup模块: `<name>_sup`
